window.opt||(opt={});opt.x=opt.x||{};opt.c=opt.c||{};
opt.fn={_el:0,parse:function(a){if(a=="false")return false;if(a=="true")return true;if(parseFloat(a).toString()==a)return parseFloat(a);return a},init:function(){var a=window.location.search.substr(1).split("&");if(window.localStorage)for(var b=0;b<localStorage.length;b++){var c=localStorage.key(b);if(c.indexOf("opt_")==0&&c.length)window.opt[c.substr(4)]=window.opt.fn.parse(localStorage[c])}for(c=0;c<a.length;c++){b=a[c].split("=");window.opt[b[0]]=b[1]?b[1]:true}},close:function(){if(opt.fn._el)try{opt.fn._el.parentNode.removeChild(opt.fn._el)}catch(a){}opt.fn._el=
0},show:function(){opt.fn.close();var a=opt.fn._el=document.createElement("div"),b='<div style="padding:7px;padding-bottom:100px;"><h1 onclick="opt.fn.close()">'+(opt.appName||"")+" settings</h1>";for(var c in opt.x)b+='<input type="checkbox" name="'+c+'" id="'+c+'" '+(opt[c]?"checked":"")+' onchange="opt.fn.handleBoolean(this)"> <label for="'+c+'">'+opt.x[c]+" <i>("+c+")</i></label><br>";b+='<br><button onclick="opt.fn.close()">Exit settings</button></div>';a.innerHTML=b;a.style.position="absolute";
a.style.top=0;a.style.left=0;a.style.width="100%";a.style.backgroundColor="#fff";a.style.padding="0";a.style.zIndex=999999999999;a.onclick=function(d){d=d||window.event;(d.target||d.srcElement).tagName.toLowerCase()=="div"&&window.opt.fn.close()};document.body.appendChild(a)},handleBoolean:function(a){opt.fn.set(a.name,a.checked)},set:function(a,b){if(typeof opt.c[a]=="function")b=opt.c[a](b)||b;opt[a]=b;if(window.localStorage)localStorage["opt_"+a]=b.toString()}};opt.fn.init();
function searchStyle(a){if(cacheState[a]==2)return"fresh_cache";else if(cacheState[a]==1)return"old_cache";return""}
function onLine(){if(navigator.onLine===undefined)return true;var a=navigator.onLine;if(a==false){var b=(+new Date-parseInt(localStorage.getItem("cache_last_updated")))/1E3;if(!isNaN(b)){var c="";c=b<60?"less than a minute":b<3600?Math.ceil(b/60)+" minutes":b<86400?Math.ceil(b/60/60)+" hours":Math.ceil(b/60/60/24)+" days";document.getElementById("offline_status").value="Offline (Cache "+c+" old)"}}return a}var cachequeue=[],db=null;
function open_db(){if(!window.db&&window.openDatabase)window.db=openDatabase("waves","1.0","Offline Wave Cache",5242880)}
function offline_cache(){if(onLine()!=false){open_db();if(window.db){db.transaction(function(a){a.executeSql("DROP TABLE inbox")});localStorage.setItem("cache_last_updated",+new Date);callbacks[wave.robot.search("in:inbox",0,42)]=function(a){for(var b=a.data.searchResults.digests,c=0;c<b.length;c++){a=b[c];cachequeue.push(a);console.log(a.waveId)}setTimeout(cache_cycle,1E3)};runQueue()}}}var cacheState={};
try{if(window.localStorage&&localStorage.cacheState)for(var cs=JSON.parse(localStorage.getItem("cacheState")),i=0;i<cs.length;i++)cacheState[cs[i]]=1}catch(err$$1){}
function cache_cycle(){if(window.db){var a=null;if(a=cachequeue.shift()){console.log("caching wave"+a.waveId);callbacks[wave.robot.fetchWave(a.waveId,a.waveId.replace(/w\+.+/g,"conv+root"))]=function(b){console.log("acquired data for"+a.waveId);db.transaction(function(c){console.log("fetched wave"+a.waveId);c.executeSql("CREATE TABLE IF NOT EXISTS inbox (waveid, result, data, date)");c.executeSql("DELETE FROM inbox WHERE waveid = ?",[a.waveId],function(d){d.executeSql("INSERT INTO inbox (waveid, result, data, date) VALUES (?, ?, ?, ?)",
[a.waveId,JSON.stringify(a),JSON.stringify(b),new Date-0],function(){console.log("done caching wave"+a.waveId);if(document.getElementById(a.waveId))document.getElementById(a.waveId).className="search fresh_cache";cacheState[a.waveId]=2;var g=[];for(var f in cacheState)g.push(f);localStorage.setItem("cacheState",JSON.stringify(g));setTimeout(cache_cycle,1E3)})})});return true};runQueue()}}}
function resultClass(a){if(cacheState[a])if(cacheState[a]==1)return"old_cache";else{if(cacheState[a]==2)return"fresh_cache"}else return""}window.console||(console={log:function(){}});var screen_size=document.documentElement.clientWidth||innerWidth,small_screen=screen_size<500,loadIds={};searchLastIndex=0;current_search="";
var edit_box,edit_text,search_container=document.getElementById("search_container"),wave_container=document.getElementById("wave_container"),mobilewebkit=navigator.userAgent.indexOf("WebKit")!=-1&&navigator.userAgent.indexOf("Mobile")!=-1,current_wave="",current_wavelet="",auto_reload=false,lasthash="chunkybacon",current_page=0,search_outdated=false,searchscroll=0,scrollto_position=-1;if(mobilewebkit)document.body.className+=" mobilewebkit";if(!window.onLine)window.onLine=function(){return true};
opt.appName="&mu;wave";opt.x.multipane="Enable multipane viewing experience (note, you must reload the page for changes to take effect)";opt.x.touchscroll="Add the TouchScroll library to do cool scrolly things on iPad Multipane (do not use on Desktop)";opt.x.no_animate="Disable animated scrolling effect";opt.x.no_scrollhistory="Do not save search scroll position and restore to it";opt.x.old_results="Old results panel style";opt.x.offline="Automatically cache inbox when online to support offline mode";
opt.x.largeFont="Use a larger font";opt.x.prefetch="Prefetch waves and load them, way faster and also not real time";opt.x.gadgets="Enable real wave gadget support (slow on mobile)";opt.x.render_state="If a gadget can not be internally rendered, display the gadget state";opt.x.bigspace="Add a large blank space under waves so the keyboard isn't messed up";opt.x.recursive_renderer="Use old version of tree wave renderer, only works on Wave Protocol 0.21 or below";opt.x.no_sig="Do not automatically add <i>posted with micro-wave</i> signature";
opt.x.use_protocol_21="Use old 0.21 version of wave protocol";opt.x.gsa="Show interface for changing gadget states (must have native gadgets enabled)";opt.x.owner_utils="Enable utilities for wave creators";opt.x.no_autoscroll="Disable smart autoscroll to latest blip";opt.x.swipe="Enable swiping gesture to navigate between blips (swipe left = prev, swipe right = next)";opt.x.keyboard="Enable keyboard shortcuts";opt.gadgets===undefined&&screen_size>900&&opt.fn.set("gadgets",true);
opt.bigspace===undefined&&mobilewebkit&&opt.fn.set("bigspace",true);if(opt.multipane===undefined&&screen_size>900){opt.fn.set("multipane",true);mobilewebkit&&opt.touchscroll===undefined&&opt.fn.set("touchscroll",true)}var endQueue=[];function onReady(a){endQueue.push(a)}
if(opt.multipane){document.getElementById("search_parent").insertBefore(document.getElementById("appheader"),document.getElementById("search_parent").firstChild);document.body.className+=" multipane";document.getElementById("header").innerHTML="&mu;wave";wave_container.innerHTML="<div style='padding:40px'>No waves loaded yet</div>";location.hash.indexOf("search:")==-1&&onReady(function(){autosearch("in:inbox");runQueue()})}opt.c.largeFont=function(a){document.body.style.fontSize=a==true?"16px":"13px"};
var prefetched_waves={},unread_blips={};opt.c.largeFont(opt.largeFont);
function addTouchScroll(){var a=arguments,b=document.createElement("link");b.href="js/lib/touchscroll.css";b.type="text/css";b.rel="stylesheet";document.body.appendChild(b);b=document.createElement("script");b.src="js/lib/touchscroll.min.js";b.onload=function(){setTimeout(function(){for(var c=0;c<a.length;c++){var d=a[c];console.log(d);if(typeof d=="string")d=document.getElementById(d);window["touchscroll"+c]=new TouchScroll(d,{elastic:true})}},100)};document.body.appendChild(b)}
function reset_touchscroll(){document.getElementById("wave_container_parent").style.width=innerWidth-250+"px";document.getElementById("wave_container").style.width=innerWidth-250+"px";document.getElementById("search_parent").style.width="250px";document.getElementById("search_parent_container").style.width="250px"}
if(opt.touchscroll&&opt.multipane){addTouchScroll("wave_container_parent","search_parent_container");document.getElementById("wave_container_parent").style.overflow="hidden";document.getElementById("search_parent").style.overflow="hidden";document.getElementById("search_parent_container").style.overflow="hidden";document.getElementById("wave_container").style.overflow="hidden";reset_touchscroll();window.onorientationchange=reset_touchscroll;window.addEventListener("resize",reset_touchscroll,true)}
!mobilewebkit&&window.addEventListener&&opt.keyboard===undefined&&opt.fn.set("keyboard",true);if(opt.keyboard)document.body.onkeydown=function(a){if(a.target.tagName=="BODY")if(a.shiftKey&&a.keyCode==32||!a.shiftKey&&!a.ctrlKey&&a.keyCode==75){blip_prev(lastscrolled);a.preventDefault()}else if(a.keyCode==32||!a.shiftKey&&!a.ctrlKey&&a.keyCode==74){blip_next(lastscrolled);a.preventDefault()}};
opt.swipe&&function(){var a=0,b=0,c=0,d=0,g,f=0,e=function(k){if(k.touches.length==1){c=k.touches[0].pageX;d=k.touches[0].pageY;g=k.touches[0].target;f=+new Date}},j=function(k){if(k.touches.length==1){a=k.touches[0].pageX;b=k.touches[0].pageY}},h=function(){var k=a-c,m=b-d,l=g;if(l){for(;!l.blipId&&l!=document.body;)l=l.parentNode;if(l.blipId)if(Math.abs(m)<10)if(Math.abs(k)>30)k>0?blip_prev(l.blipId):blip_next(l.blipId)}};if(mobilewebkit){document.body.addEventListener("touchstart",e,true);document.body.addEventListener("touchmove",
j,true);document.body.addEventListener("touchend",h,true)}else{document.body.addEventListener("mousedown",function(k){e({touches:[k]})},true);document.body.addEventListener("mousemove",function(k){j({touches:[k]})},true);document.body.addEventListener("mouseup",function(k){h({touches:[k]})},true)}}();
function userList(a,b){var c=small_screen?2:5,d=document.createElement("span");if(a.length<=c||b){d.innerHTML=a.join(", ").replace(/antimatter15@googlewave.com/g,"<a href='http://antimatter15.com' target='_blank'>antimatter15</a>").replace(/@.*?(\,|$)/g,"$1");if(b){c=document.createElement("a");c.innerHTML=" (fewer)";c.href="javascript:void(0)";c.onclick=function(){d.parentNode.replaceChild(userList(a),d);return false};d.appendChild(c)}}else{d.innerHTML=a.slice(0,c).join(", ").replace(/antimatter15@googlewave.com/g,
"<a href='http://antimatter15.com'>antimatter15</a>").replace(/@.*?(\,|$)/g,"$1");var g=document.createElement("a");g.innerHTML=" ... ("+(a.length-c)+" more)";g.href="javascript:void(0)";g.onclick=function(){d.parentNode.replaceChild(userList(a,true),d);return false};d.appendChild(g)}return d}
function format_time(a){if(typeof a=="number"){var b=new Date;b.setTime(a);a=b}b=a.getHours();var c="am";if(b>12){b-=12;c="pm"}if(b==0)b=12;var d=a.getMinutes().toString();if(d.length==1)d="0"+d;return a.getMonth()+1+"/"+a.getDate()+" "+b+":"+d+c}function inline_blip_render(a){var b=document.createElement("div");b.className="thread";blip_render(a,b);return b}
function blip_render(a,b){var c=msg.data.blips[a];if(!(!c||c.dom)){var d=renderBlip(c);msg.data.blips[a].dom=d;d.className="message";d.blipId=a;var g=document.createElement("div");g.className="info";c.info=g;var f="";f=chronological_blips[0]==a?chronological_blips.length==1?' <span class="blipend">X</span>':' <span class="blipend">&larr;</span>':chronological_blips[chronological_blips.length-1]==a?" <span class='blipstart'>&rarr;</span></div>":" <span class='nextarr'>&harr;</span></div>";g.innerHTML=
"<div style='float:right;color:#555'>"+format_time(c.lastModifiedTime).toString()+f;g.appendChild(userList(c.contributors));g.onclick=function(e){e=e||window.event;e.cancelBubble=true;e.stopPropagation&&e.stopPropagation();(e.target||e.srcElement).tagName.toLowerCase()!="a"&&blip_next(c.blipId)};d.onclick=function(e){e=e||window.event;e.cancelBubble=true;e.stopPropagation&&e.stopPropagation();if((e.target||e.srcElement).tagName.toLowerCase()!="a"){console.log(c);g.parentNode.insertBefore(create_contextmenu(c),
g.nextSibling)}};d.insertBefore(g,d.firstChild);b.appendChild(d);a==chronological_blips[scrollto_position]&&setTimeout(function(){blip_scroll(scrollto_position)},500);return d}}function create_wave(){var a=loading("Creating wave...");setTimeout(function(){var b={};callbacks[wave.robot.createWavelet([],b)]=function(c){loading(a);setTimeout(function(){hashHandler("wave:"+c.data.waveId,true);runQueue()},100)};wave.wavelet.setTitle("New Wave",b.waveId,b.waveletId);runQueue()},500)}
function diff(a,b){for(var c=a.length,d=b.length,g=-1,f=-1;g++<c&&a[g]==b[g];);for(;f++<c&&a[c-f]==b[d-f];);return[g,c-f+1,b.substring(g,d-f+1)]}var current_blip=null,context_box,reply_box,reply_text,cancel,post;
function create_reply_box(a){if(window.content_box)try{content_box.innerHTML="";content_box.parentNode.removeChild(content_box)}catch(b){}context_box=document.createElement("div");reply_box=document.createElement("div");reply_box.innerHTML="<div class='alert'><b>Write a Reply</b></div>";reply_text=document.createElement("textarea");cancel=document.createElement("button");post=document.createElement("button");cancel.innerHTML="Cancel";post.innerHTML="Post";cancel.onclick=function(){if(reply_text.value.split(" ").length<
42||confirm("Are you sure you want to cancel?")){context_box.style.display="none";current_blip=null}};post.onclick=function(){reply_text.disabled="disabled";setTimeout(function(){a?wave.blip.contentCreateChild(reply_text.value,current_blip.blipId,current_blip.waveId,current_blip.waveletId):wave.blip.contentContinueThread(reply_text.value,current_blip.blipId,current_blip.waveId,current_blip.waveletId);loadWave(current_blip.waveId);auto_reload=true;runQueue()},100)};context_box.style.marginTop="10px";
reply_box.appendChild(reply_text);reply_box.appendChild(post);reply_box.appendChild(cancel);context_box.appendChild(reply_box);context_box.style.display="none";var c=reply_text.disabled="";if(navigator.userAgent.indexOf("Opera Mini")!=-1)c=" on Opera Mini";else if(mobilewebkit)c=navigator.userAgent.indexOf("Android")!=-1?" on Android":navigator.userAgent.indexOf("iPad")!=-1?" on iPad":navigator.userAgent.indexOf("iPod")!=-1?" on iPod":" on iPhone";reply_text.value="";if(!opt.no_sig)reply_text.value=
"\n\nPosted with micro-wave.appspot.com"+c;reply_text.className="reply_box";return context_box}ctx_menu=null;
function create_contextmenu(a){function b(){d.style.display="none";d.parentNode.removeChild(d)}if(!onLine())return document.createElement("div");try{ctx_menu.style.display="none";ctx_menu.parentNode.removeChild(ctx_menu)}catch(c){}var d=document.createElement("div");current_blip=a;d.style.zIndex=32;var g={Reply:function(){current_blip.dom.parentNode.insertBefore(create_reply_box(),current_blip.dom.nextSibling);context_box.className=a.childBlipIds.length>0?"thread":"";context_box.style.display="";
reply_text.focus();b()},Indented:function(){current_blip.dom.parentNode.insertBefore(create_reply_box(true),current_blip.dom.nextSibling);context_box.className=a.childBlipIds.length>0?"thread":"";context_box.style.display="";reply_text.focus();b()},Delete:function(){confirm("Are you sure you want to delete the blip?")&&setTimeout(function(){wave.blip["delete"](current_blip.blipId,current_blip.waveId,current_blip.waveletId);loadWave(current_blip.waveId);auto_reload=true;runQueue();b()},100);b()},Edit:function(){current_blip.dom.parentNode.insertBefore(create_edit_box(),
current_blip.dom.nextSibling);var j=0;try{for(var h=current_blip.annotations.length,k=0;k<h&&current_blip.annotations[k].name!="conv/title";k++);if(k<h)j=current_blip.annotations[k].range.end}catch(m){}edit_text.value=current_blip.content.substr(j+1);edit_text.focus();b()}};if(a.blipId==msg.data.waveletData.rootBlipId)g["Change Title"]=function(){var j=prompt("Enter new wavelet title",msg.data.waveletData.title);if(j){wave.wavelet.setTitle(j,a.waveId,a.waveletId);loadWave(a.waveId,a.waveletId);auto_reload=
true;runQueue()}};for(var f in g){var e=document.createElement("a");e.href="javascript:void(0)";e.onclick=g[f];e.innerHTML=f;d.appendChild(e);d.appendChild(document.createTextNode(" / "))}e=document.createElement("a");e.href="javascript:void(0);";e.style.color="red";e.innerHTML="Close";e.onclick=function(){b()};d.appendChild(e);d.className="contextmenu";return ctx_menu=d}
function create_edit_box(){edit_box=document.createElement("div");edit_box.style.marginRight="6px";edit_box.innerHTML="<div class='alert'><b>Edit Blip (Beta)</b></div>";edit_text=document.createElement("textarea");cancel_edit=document.createElement("button");submit_edit=document.createElement("button");cancel_edit.innerHTML="Cancel";submit_edit.innerHTML="Submit";cancel_edit.onclick=function(){edit_box.style.display="none";current_blip=null};submit_edit.onclick=function(){edit_text.disabled="disabled";
setTimeout(function(){var a=0;try{for(var b=current_blip.annotations.length,c=0;c<b&&current_blip.annotations[c].name!="conv/title";c++);if(c<b)a=current_blip.annotations[c].range.end}catch(d){}b=diff(current_blip.content.substr(a),"\n"+edit_text.value);console.log(b);console.log(current_blip.content,"\n"+edit_text.value);wave.blip.replace_range(b[2],a+b[0],a+b[1],current_blip.blipId,current_blip.waveId,current_blip.waveletId);loadWave(current_blip.waveId);auto_reload=true;runQueue()},100)};edit_box.style.marginTop=
"10px";edit_box.appendChild(edit_text);edit_box.appendChild(submit_edit);edit_box.appendChild(cancel_edit);edit_text.style.height=Math.max(current_blip.dom.offsetHeight,100)+"px";edit_text.className="edit_box";return edit_box}var gstates={},REMOTE_RPC_RELAY_URL="http://www.gmodules.com/gadgets/files/container/rpc_relay.html",DEFAULT_GADGET_MODE={"${playback}":"0","${edit}":"1"};function registerRpc(a,b){gadgets.rpc.register(a,function(){b(this.s,this.f,this.a)})}
function init_gadget_handler(a){if(window.gadgets)a();else{Math.random().toString(36).substr(4);var b=document.createElement("script");b.src="https://wave.google.com/gadgets/js/core:rpc?debug=1&c=1";(function(){if(window.gadgets){initGadgetSystem();a()}else setTimeout(arguments.callee,100)})();document.body.appendChild(b)}}
function extractGadgetState(a){console.log(a);var b=gstates[a].participants,c=gstates[a].state;gadgets.rpc.call(a,"wave_gadget_mode",null,DEFAULT_GADGET_MODE);gadgets.rpc.call(a,"wave_participants",null,b);gadgets.rpc.call(a,"wave_gadget_state",null,c);gadgets.rpc.call(a,"wave_private_gadget_state",null,{})}
function initGadgetSystem(){registerRpc("wave_enable",function(a,b){gadgets.rpc.setRelayUrl(b,REMOTE_RPC_RELAY_URL);extractGadgetState(b)});registerRpc("resize_iframe",function(a,b,c){document.getElementById(b).height=c[0]});gadgets.rpc.registerDefault(function(){var a=this.s,b=this.a[0],c=this.f;console.log(this);if(a=="wave_gadget_state"){console.log("updating state");for(var d in b)gstates[c].state[d]=b[d];wave.blip.update_element(b,gstates[c].blipId,current_wave,current_wavelet);runQueue();gadgets.rpc.call(c,
"wave_gadget_state",null,gstates[c].state)}console.log(a,b)})}function create_gadget_frame(a,b,c){var d=document.createElement("div");d.innerHTML='<iframe name="'+a+'" >';d=d.firstChild;d.id=a;d.width="320px";d.height="250px";d.frameBorder="yes";d.scrolling="no";d.marginHeight=0;d.marginWidth=0;c=c||document.body;c.appendChild(d);d.src=b;return d}
function load_native_gadget(a,b,c,d){var g="gadget_frame"+Math.random().toString(36).substr(4);console.log(b);for(var f={myId:username,authorId:b.properties.author,participants:{}},e=msg.data.waveletData.participants,j=e.length;j--;)f.participants[e[j]]={id:e[j],displayName:e[j].replace(/@.*$/,""),thumbnailUrl:"https://wave.google.com/a/google.com/static/images/unknown.jpg"};gstates[g]={state:a,participants:f,blipId:c.blipId};var h=opt.gsa?"http://anti15.chemicalservers.com/debugwave.xml":opt.gsa1?
"http://anti15.chemicalservers.com/state.xml":b.properties.url,k="http://www.gmodules.com/gadgets/ifr?container=wave&view=default&debug=0&lang=en&country=ALL&nocache=0&wave=1&mid="+encodeURIComponent(g)+"&parent="+encodeURIComponent(location.protocol+"//"+location.host+location.pathname)+"&url="+encodeURIComponent(h);init_gadget_handler(function(){create_gadget_frame(g,k,d);console.log("creating "+g+" for gadget "+h)})}function native_gadget(){}
function renderGadget(a,b){var c={},d=[];for(var g in a.properties){if(g!="url"&&g!="author")c[g]=a.properties[g];d.push(g)}var f=document.createElement("div");f.style.margin="10px";var e=a.properties.url;f.innerHTML="<b>gadget</b> "+e+" <br>";if(window.opt.gadgets){load_native_gadget(c,a,b,f);return f}if(e=="http://wave-api.appspot.com/public/gadgets/areyouin/gadget.xml"){var j={y:[],n:[],m:[]};for(g in c)/:answer$/.test(g)&&j[c[g]].push(g.substr(0,g.length-7));for(var h in j){f.innerHTML+="<br><span style='color:red;font-weight:bold'>"+
{m:"Maybe",y:"Yes",n:"No"}[h]+"</span><br> ";if(j[h].length==0)f.innerHTML+="(None) <br>";for(g=0;g<j[h].length;g++)f.innerHTML+=j[h][g].replace(/@googlewave.com/g,"")+' <span style="color: gray;font-style: italic">'+(c[j[h][g]+":status"]||"")+"</span><br>"}}else if(e=="http://plus-one.appspot.com/plus-one.xml"){j=0;for(g in c)j+=parseInt(c[g]);f.innerHTML+="<br><b>Votes:</b> "+j+"/"+d.length}else if(e=="http://www.elizabethsgadgets.appspot.com/public/gadget.xml")f.innerHTML+="<br> <b>Pluses</b> ("+
(c.pluses||0)+")&nbsp;&nbsp;&nbsp;&nbsp;<b>Minuses</b> ("+(c.minuses||0)+")";else if(e=="http://pushyrobot.appspot.com/gadgets/github.xml")f.innerHTML+="<pre>"+JSON.stringify(JSON.parse(unescape(c.commit)),null,2)+"</pre>";else if(e=="http://everybodywave.appspot.com/gadget/image/gadget.xml")f.innerHTML+='<img src="'+c.imgUrl+'" width="'+c.imgWidth+'" height="'+c.imgHeight+'">';else if(e=="http://wavepollo.appspot.com/wavepollo/com.appspot.wavepollo.client.PolloWaveGadget.gadget.xml"){h={};for(j in c)if(j.indexOf("MVOTE_")==
0)if(g=j.match(/MVOTE_(.+)(OPT_.+)$/)){h[g[2]]||(h[g[2]]=[]);h[g[2]].push(g[1])}for(j in h){f.innerHTML+="<br><span style='color:red;font-weight:bold'>"+c[j]+"</span> ("+h[j].length+")<br> ";for(g=0;g<h[j].length;g++)f.innerHTML+=h[j][g].replace(/@googlewave.com/g,"")+", "}}else if(e=="https://statusee.appspot.com/gadget/statusee.xml")f.innerHTML+="<b>Status</b> "+({notstarted:"Not started",describing:"Describing",brainstorming:"Brainstorming",inprogress:"In Progress",inreview:"In Review",pending:"Pending",
testing:"Testing",completed:"Completed",rejected:"Rejected",canceled:"Canceled"}[c.sel]||c.sel.substr(7));else if(e=="http://wave-poll.googlecode.com/svn/trunk/src/poll.xml")for(j in c){h=JSON.parse(c[j]).participants;f.innerHTML+="<br><span style='color:red;font-weight:bold'>"+j.substr(7)+"</span> ("+h.length+")<br> ";for(g=0;g<h.length;g++)f.innerHTML+=h[g].replace(/@googlewave.com/g,"")+", "}else if(e=="https://everybodywave.appspot.com/gadget/miniroster/main.xml"){f.innerHTML+="<br><span style='color:red;font-weight:bold'>Assigned</span> ("+
d.length+")<br> ";for(j in c)f.innerHTML+=j.split("~")[3]+", "}else if(e=="http://www.nebweb.com.au/wave/likey.xml")f.innerHTML+="<br> <b>Like</b> ("+(c.likeCount||0)+")&nbsp;&nbsp;&nbsp;&nbsp;<b>Dislike</b> ("+(c.dislikeCount||0)+")";else if(window.opt.render_state||JSON.stringify(c).length<1337){console.log("Unknown Gadget",e);a=document.createTextNode(JSON.stringify(c,null,2));c=document.createElement("div");c.appendChild(a);f.innerHTML+='<div class="monospace">'+c.innerHTML+"</div>"}return f}
function loading(a,b){var c=document.getElementById("loading"),d=typeof document.createElement("div").style.opacity!="undefined";c.style.top=scrollY+"px";if(typeof a=="number"){if(d)c.style.opacity="0";else c.style.display="none";delete loadIds[a];setTimeout(function(){c.style.display="none"},500)}else{var g=Math.random()*42;loadIds[g]=true;setTimeout(function(){c.style.top=scrollY+"px";if(loadIds[g]){c.style.display="";if(d)c.style.opacity="1";document.getElementById("loadingtext").innerHTML="<b>Loading</b> "+
a}},b?0:0);return g}}var lastscrolled="";function blip_scroll(a){if(a<0)a=chronological_blips.length+a;try{msg.data.blips[lastscrolled].info.className="info"}catch(b){}lastscrolled=chronological_blips[a];if(msg.data.blips[chronological_blips[a]].dom){msg.data.blips[lastscrolled].info.className="info selected";scroll_wavepanel(msg.data.blips[chronological_blips[a]].dom.offsetTop);return true}return false}
function blip_index(a){return[].indexOf?chronological_blips.indexOf(a):function(b,c,d){for(d=c.length;d--&&c[d]!=b;);return d}(a,chronological_blips)}function blip_next(a){try{for(var b=blip_index(a);b&&blip_scroll(--b)==false;);}catch(c){}}function blip_prev(a){try{var b=blip_index(a),c=chronological_blips.length-1;if(!(b<0))for(;b<c&&blip_scroll(++b)==false;);}catch(d){}}
function animated_scroll(a,b){var c=a==window,d=c?pageYOffset:a.scrollTop;if(d!=b){var g=Math.min(1E3,2*Math.sqrt(42*Math.abs(b-d))),f,e=+new Date+g;(f=function(){var j=Math.min(1,1-(e-new Date)/g),h=(b-d)*(-Math.cos(j*Math.PI)/2+0.5)+d;if(c)scrollTo(0,h);else a.scrollTop=h;j<1&&setTimeout(f,0)})()}}
function scroll_wavepanel(a){var b=document.getElementById("wave_container_parent");a=a<0?b.scrollHeight+1+a:a;if(opt.multipane)if(opt.touchscroll)touchscroll0.scrollTo(0,a);else if(opt.no_animate)b.scrollTop=a;else animated_scroll(b,a);else{a=a<0?innerHeight+1+a:a;opt.no_animate?scrollTo(0,a):animated_scroll(window,a)}}
function scroll_searchpanel(a){var b=document.getElementById("search_parent_container");a=a<0?b.scrollHeight+1+a:a;if(opt.multipane)if(opt.touchscroll)touchscroll1.scrollTo(0,a);else if(opt.no_animate)b.scrollTop=a;else animated_scroll(b,a);else{a=a<0?innerHeight+1+a:a;opt.no_animate?scrollTo(0,a):animated_scroll(window,a)}}function hide_float(){document.getElementById("floating_menu").className=""}
function markWaveRead(){wave.robot.folderAction("markAsRead",current_wave,current_wavelet);hide_float();search_outdated=true;runQueue()}function archiveWave(){wave.robot.folderAction("archive",current_wave,current_wavelet);hide_float();runQueue()}
function update_scroll(){if(current_page==0)searchscroll=scrollY;document.getElementById("loading").style.top=scrollY+"px";var a=scrollY+window.innerHeight-64;if(mobilewebkit)document.getElementById("floating_menu").style["-webkit-transform"]="translateY("+a+"px)";else document.getElementById("floating_menu").style.top=a+"px"}window.onresize=document.onscroll=window.onscroll=update_scroll;mobilewebkit&&setInterval(document.onscroll,1E3);
function toggle_float(){document.getElementById("floating_menu").className="minimized";setTimeout(function(){document.getElementById("floating_menu").className=""},500)}username="wheisenberg@googlewave.com";function getUsername(){callbacks[wave.robot.fetchWave("googlewave.com!w+bWEBb5mBA","googlewave.com!conv+poop")]=function(a){username=a.error.message.match(/internalError: (.+@.+) is not a participant/)[1];return true}}
wave={robot:{fetchWave:function(a,b){return queueOp("wave.robot.fetchWave",{waveId:a,waveletId:b})},search:function(a,b,c){return queueOp("wave.robot.search",{query:a,index:b,numResults:c})},folderAction:function(a,b,c){return queueOp("wave.robot.folderAction",{waveId:b,modifyHow:a,waveletId:c})},notifyCapabilitiesHash:function(a){var b=(opt.use_protocol_21?0.21:0.22).toString();return queueOp("wave.robot.notifyCapabilitiesHash",{protocolVersion:a||b})},createWavelet:function(a,b){var c="TBD_"+g+
"_0x"+(Math.random()*9E5).toString(16),d=username.replace(/^.+@/,""),g=d+"!conv+root";d=d+"!TBD_0x"+(Math.random()*9E5).toString(16);b||(b={});b.waveId=d;b.waveletId=g;b.rootBlipId=c;return queueOp("wave.robot.createWavelet",{waveletId:g,waveletData:{waveletId:g,waveId:d,rootBlipId:c,participants:a},waveId:d})}},wavelet:{appendBlip:function(a,b,c,d){var g="TBD_"+username.replace(/^.+@/,"")+"!conv+root_0x"+(Math.random()*9E5).toString(16);return queueOp("wave.wavelet.appendBlip",{waveletId:d,waveId:c,
blipId:g,blipData:{waveletId:d,blipId:g,waveId:c,content:a,parentBlipId:b},parentBlipId:b})},modifyParticipantRole:function(a,b,c,d){return queueOp("wave.wavelet.modifyParticipantRole",{waveletId:d,waveId:c,participantId:a,participantRole:b})},removeTag:function(a,b,c){return queueOp("wave.wavelet.modifyTag",{waveletId:c,waveId:b,name:a,modifyHow:"remove"})},addTag:function(a,b,c){return queueOp("wave.wavelet.modifyTag",{waveletId:c,waveId:b,name:a})},setTitle:function(a,b,c){return queueOp("wave.wavelet.setTitle",
{waveletId:c,waveId:b,waveletTitle:a})},participant:{add:function(a,b,c){return queueOp("wave.wavelet.participant.add",{waveId:b,waveletId:c,participantId:a})}}},document:{appendMarkup:function(a,b,c,d){return queueOp("wave.document.appendMarkup",{waveletId:d,waveId:c,blipId:b,content:a})},modify:function(a,b,c,d){return queueOp("wave.document.modify",{waveletId:d,waveId:c,blipId:b,modifyAction:a})},modify_range:function(a,b,c,d,g,f){return queueOp("wave.document.modify",{waveletId:f,waveId:g,blipId:d,
modifyAction:a,range:{start:b,end:c}})}},blip:{"delete":function(a,b,c){return queueOp("wave.blip.delete",{waveletId:c,waveId:b,blipId:a})},replace:function(a,b,c,d){return wave.document.modify({modifyHow:"REPLACE",values:["\n"+a]},b,c,d)},replace_range:function(a,b,c,d,g,f){return wave.document.modify_range({modifyHow:"REPLACE",values:[a]},b,c,d,g,f)},update_element:function(a,b,c,d){return queueOp("wave.document.modify",{waveletId:d,waveId:c,blipId:b,modifyAction:{modifyHow:"UPDATE_ELEMENT",elements:[{type:"GADGET",
properties:a}]},modifyQuery:{restrictions:{},maxRes:1,elementMatch:"GADGET"}})},insert:function(a,b,c,d){return wave.document.modify({modifyHow:"INSERT",values:["\n"+a]},b,c,d)},append:function(a,b,c,d){return wave.document.modify({modifyHow:"INSERT_AFTER",values:[a]},b,c,d)},createChild:function(a,b,c,d){return queueOp("wave.blip.createChild",{waveletId:c,waveId:b,blipId:a,blipData:{waveletId:c,blipId:d,waveId:b,content:"",parentBlipId:a}})},continueThread:function(a,b,c,d){return queueOp("wave.blip.continueThread",
{waveletId:c,waveId:b,blipId:a,blipData:{waveletId:c,blipId:d,waveId:b,content:"",parentBlipId:a}})},contentCreateChild:function(a,b,c,d){var g="TBD_"+d+"_0x"+(Math.random()*9E5).toString(16);wave.blip.createChild(b,c,d,g);wave.blip.replace(a,g,c,d)},contentContinueThread:function(a,b,c,d){var g="TBD_"+d+"_0x"+(Math.random()*9E5).toString(16);wave.blip.continueThread(b,c,d,g);wave.blip.replace(a,g,c,d)}}};opt.appName="&mu;wave";opt.x.multipane="Enable multipane viewing experience (note, you must reload the page for changes to take effect)";
opt.x.touchscroll="Add the TouchScroll library to do cool scrolly things on iPad Multipane (do not use on Desktop)";opt.x.no_animate="Disable animated scrolling effect";opt.x.no_scrollhistory="Do not save search scroll position and restore to it";opt.x.old_results="Old results panel style";opt.x.offline="Automatically cache inbox when online to support offline mode";opt.x.largeFont="Use a larger font";opt.x.prefetch="Prefetch waves and load them, way faster and also not real time";opt.x.gadgets="Enable real wave gadget support (slow on mobile)";
opt.x.render_state="If a gadget can not be internally rendered, display the gadget state";opt.x.bigspace="Add a large blank space under waves so the keyboard isn't messed up";opt.x.recursive_renderer="Use old version of tree wave renderer, only works on Wave Protocol 0.21 or below";opt.x.no_sig="Do not automatically add <i>posted with micro-wave</i> signature";opt.x.use_protocol_21="Use old 0.21 version of wave protocol";opt.x.gsa="Show interface for changing gadget states (must have native gadgets enabled)";
opt.x.owner_utils="Enable utilities for wave creators";opt.x.no_autoscroll="Disable smart autoscroll to latest blip";opt.x.swipe="Enable swiping gesture to navigate between blips (swipe left = prev, swipe right = next)";opt.x.keyboard="Enable keyboard shortcuts";opt.gadgets===undefined&&screen_size>900&&opt.fn.set("gadgets",true);opt.bigspace===undefined&&mobilewebkit&&opt.fn.set("bigspace",true);
if(opt.multipane===undefined&&screen_size>900){opt.fn.set("multipane",true);mobilewebkit&&opt.touchscroll===undefined&&opt.fn.set("touchscroll",true)}endQueue=[];function onReady(a){endQueue.push(a)}
if(opt.multipane){document.getElementById("search_parent").insertBefore(document.getElementById("appheader"),document.getElementById("search_parent").firstChild);document.body.className+=" multipane";document.getElementById("header").innerHTML="&mu;wave";wave_container.innerHTML="<div style='padding:40px'>No waves loaded yet</div>";location.hash.indexOf("search:")==-1&&onReady(function(){autosearch("in:inbox");runQueue()})}opt.c.largeFont=function(a){document.body.style.fontSize=a==true?"16px":"13px"};
prefetched_waves={};unread_blips={};opt.c.largeFont(opt.largeFont);
function addTouchScroll(){var a=arguments,b=document.createElement("link");b.href="js/lib/touchscroll.css";b.type="text/css";b.rel="stylesheet";document.body.appendChild(b);b=document.createElement("script");b.src="js/lib/touchscroll.min.js";b.onload=function(){setTimeout(function(){for(var c=0;c<a.length;c++){var d=a[c];console.log(d);if(typeof d=="string")d=document.getElementById(d);window["touchscroll"+c]=new TouchScroll(d,{elastic:true})}},100)};document.body.appendChild(b)}
function reset_touchscroll(){document.getElementById("wave_container_parent").style.width=innerWidth-250+"px";document.getElementById("wave_container").style.width=innerWidth-250+"px";document.getElementById("search_parent").style.width="250px";document.getElementById("search_parent_container").style.width="250px"}
if(opt.touchscroll&&opt.multipane){addTouchScroll("wave_container_parent","search_parent_container");document.getElementById("wave_container_parent").style.overflow="hidden";document.getElementById("search_parent").style.overflow="hidden";document.getElementById("search_parent_container").style.overflow="hidden";document.getElementById("wave_container").style.overflow="hidden";reset_touchscroll();window.onorientationchange=reset_touchscroll;window.addEventListener("resize",reset_touchscroll,true)}
!mobilewebkit&&window.addEventListener&&opt.keyboard===undefined&&opt.fn.set("keyboard",true);if(opt.keyboard)document.body.onkeydown=function(a){if(a.target.tagName=="BODY")if(a.shiftKey&&a.keyCode==32||!a.shiftKey&&!a.ctrlKey&&a.keyCode==75){blip_prev(lastscrolled);a.preventDefault()}else if(a.keyCode==32||!a.shiftKey&&!a.ctrlKey&&a.keyCode==74){blip_next(lastscrolled);a.preventDefault()}};
opt.swipe&&function(){var a=0,b=0,c=0,d=0,g,f=0,e=function(k){if(k.touches.length==1){c=k.touches[0].pageX;d=k.touches[0].pageY;g=k.touches[0].target;f=+new Date}},j=function(k){if(k.touches.length==1){a=k.touches[0].pageX;b=k.touches[0].pageY}},h=function(){var k=a-c,m=b-d,l=g;if(l){for(;!l.blipId&&l!=document.body;)l=l.parentNode;if(l.blipId)if(Math.abs(m)<10)if(Math.abs(k)>30)k>0?blip_prev(l.blipId):blip_next(l.blipId)}};if(mobilewebkit){document.body.addEventListener("touchstart",e,true);document.body.addEventListener("touchmove",
j,true);document.body.addEventListener("touchend",h,true)}else{document.body.addEventListener("mousedown",function(k){e({touches:[k]})},true);document.body.addEventListener("mousemove",function(k){j({touches:[k]})},true);document.body.addEventListener("mouseup",function(k){h({touches:[k]})},true)}}();
function chronological_blip_render(a){var b=[];for(var c in msg.data.blips)b.push(msg.data.blips[c]);b=b.sort(function(g,f){return g.lastModifiedTime-f.lastModifiedTime});var d=b.length-1;(function(){for(var g=Math.max(0,d-10);d>=g;d--){var f=d,e=blip_render(b[f].blipId,a);if(msg.data.blips[b[f].parentBlipId]&&e){var j=document.createElement("blockquote");f=msg.data.blips[b[f].parentBlipId];var h=f.contributors.join(", ").replace(/@googlewave.com/g,"")+":"+f.content;j.innerHTML=h.substr(0,140)+(h.length>
140?"...":"");j.setAttribute("onclick","msg.data.blips['"+f.blipId+"'].dom.scrollIntoView()");e.insertBefore(j,e.getElementsByTagName("div")[0].nextSibling)}}g&&setTimeout(arguments.callee,0)})()}
function recursive_blip_render(a,b){var c=blip_render(a,b),d=msg.data.blips[a];if(d.childBlipIds.length>0){if(d.childBlipIds.length>1){var g=document.createElement("div");g.className="thread";for(var f=1;f<d.childBlipIds.length;f++)recursive_blip_render(d.childBlipIds[f],g);g.childNodes.length!=0&&b.appendChild(g)}recursive_blip_render(d.childBlipIds[0],b)}return c}
function bootstrap_thread_render(a){var b=msg.data.waveletData.rootThread.blipIds,c=b.length,d=0;(function(){for(var g=d+5;d<g&&d<c;)thread_render(b[d++],a);d<c&&setTimeout(arguments.callee,0)})()}
function thread_render(a,b){var c=msg.data.blips[a];if(c)if(!c.dom){var d=blip_render(a,b);c=c.replyThreadIds;var g=c.length;if(g!=0){var f=document.createElement("div");f.className="thread";b.appendChild(f);for(t=0;t<g;t++)for(var e=msg.data.threads[c[t]].blipIds,j=e.length,h=0;h<j;h++)thread_render(e[h],f)}return d}}
function renderImage(a,b){var c=document.createElement("img");c.style.display="none";c.src=a;(function(d){d.onload=function(){var g=screen_size;try{g=parseInt(getComputedStyle(document.documentElement,b).width)}catch(f){g=screen_size}if(d.width>g-21){d.style.width="100%";d.onclick=function(){d.style.width=d.style.width.indexOf("%")==-1?"100%":""}}d.style.display=""}})(c);b.appendChild(c)}
function renderBlip(a){for(var b=a.content+" ",c={},d={},g={},f=0;f<a.annotations.length;f++){var e=a.annotations[f];if(e.name.indexOf("user/d/")==0){var j=e.value.split(","),h=e.name.substr(7);if(new Date-parseInt(j[1])<36E5)g[h]="rgb("+Math.floor(205-Math.random()*100).toString()+","+Math.floor(205-Math.random()*100).toString()+","+Math.floor(205-Math.random()*100).toString()+")"}if(c[e.range.start])c[e.range.start].push(f);else c[e.range.start]=[f];if(d[e.range.end])d[e.range.end].push(f);else d[e.range.end]=
[f]}j={};var k=document.createElement("div"),m=null,l=null,o="";for(f=0;f<b.length;f++){if(c[f]||d[f]||a.elements[f]){o&&l.appendChild(document.createTextNode(o));o="";if(a.elements[f]){h=a.elements[f];if(h.type=="INLINE_BLIP")k.appendChild(inline_blip_render(h.properties.id));else if(h.type=="IMAGE"){m=document.createElement("div");m.innerHTML="<b>"+(h.properties.attachmentId||"")+"</b> "+(h.properties.caption||"")+"<br>";h.properties.url&&renderImage(h.properties.url,m);k.appendChild(m)}else if(h.type==
"INSTALLER"){m=document.createElement("div");m.style.border="3px dotted orange";m.style.margin="10px";m.innerHTML="&lt;<b>Extension Installer</b> "+h.properties.manifest+"&gt;";k.appendChild(m)}else if(h.type=="ATTACHMENT"){m=document.createElement("div");m.style.margin="10px";m.innerHTML="<b>"+h.properties.mimeType+"</b> "+h.properties.caption+"<br>";if(h.properties.mimeType.indexOf("image/")==0)renderImage(h.properties.attachmentUrl,m);else m.innerHTML+="<a href='"+h.properties.attachmentUrl+"'>Download</a>";
k.appendChild(m)}else if(h.type=="GADGET")k.appendChild(renderGadget(h,a));else h.type!="LINE"&&console.log("unknown element type",h.type,h.properties);m=document.createElement(h.properties.lineType||"p");if(h.properties.indent)m.style.marginLeft=h.properties.indent*20+"px";if(h.properties.alignment)m.style.textAlign={l:"left",c:"center",r:"right"}[h.properties.alignment];h.properties.direction&&m.setAttribute("dir",{l:"ltr",r:"rtl"}[h.properties.alignment]);k.appendChild(m)}if(c[f])for(var p=c[f],
s=p.length;s--;){e=a.annotations[p[s]];j[e.name]||(j[e.name]=[]);j[e.name].push(e.value);if(e.name.indexOf("user/e/")==0){h=e.name.substr(7);if(g[h]){var q=document.createElement("span");q.className="cursor";q.innerHTML=e.value.replace(/@.+/,"");q.style.backgroundColor=g[h];l.appendChild(q)}}}if(d[f]){p=d[f];for(s=p.length;s--;){e=a.annotations[p[s]];j[e.name].shift();j[e.name].length==0&&delete j[e.name]}}l=j["link/auto"]||j["link/manual"]||j["link/wave"]?document.createElement("a"):document.createElement("span");
m.appendChild(l);for(e in j){h=j[e][0];if(e.indexOf("style/")==0)l.style[e.substr(6)]=h;else if(e=="conv/title")l.style.fontWeight="bold";else if(e!="spell")if(e!="lang")if(e=="link/manual"||e=="link/auto")if(/^waveid:\/\//.test(h)){l.href="#wave:"+h.substr(9);l.setAttribute("onclick","ch(this)")}else if(/wave:(.+?)(\,$)/.test(h)){l.href="#wave:"+h.match(/wave:(.+?)(\,$)/)[1];l.setAttribute("onclick","ch(this)")}else{l.href=h;l.target="_blank"}else if(e=="link/wave"){l.href="#wave:"+h;l.setAttribute("onclick",
"ch(this)")}else e.indexOf("user/e")!=0&&e.indexOf("user/d")!=0&&e.indexOf("user/r")!=0&&console.log("unrecognized annotation",e,h)}}if(b.charAt(f)!="\n")o+=b.charAt(f)}o&&l.appendChild(document.createTextNode(o));return k}var queue=[],callbacks={},id_count=0;function queueOp(a,b,c){var d=(id_count++).toString();if(c)callbacks[d]=c;queue.push({id:d,method:a,params:b});return d}
if(!window.doXHR)window.doXHR=function(a,b){var c=new (window.ActiveXObject||XMLHttpRequest)("Microsoft.XMLHTTP");c.open("POST","/rpc",true);c.setRequestHeader("Content-Type","application/json");c.onreadystatechange=function(){c.readyState==4&&b(c)};c.send(a)};
function runQueue(){if(queue.length==0)return false;for(var a=[],b=0;b<queue.length;b++)a.push(queue[b].id);doXHR(JSON.stringify(queue),function(c){if(c.status==200){var d;try{d=JSON.parse(c.responseText)}catch(g){if(c.responseText.indexOf("Error 401")!=-1){alert("Your login token has expired\n"+c.responseText);return location="/?force_auth=true"}for(var f=0;f<a.length;f++){var e=null,j=a[f];if(callbacks[j]){try{e=callbacks[j]()}catch(h){}delete callbacks[j]}if(!e){alert("There was a server error, please try again. A");
c.responseText&&alert(c.responseText)}}}if(d){console.log(d);for(f=0;f<d.length;f++){j=d[f].id;e=null;if(callbacks[j]){e=callbacks[j](d[f]);delete callbacks[j]}if(d[f].error&&!e){if(d[f].error.code==401){alert("Your login token has expired\n"+c.responseText);return location="/?force_auth=true"}alert("Error "+d[f].error.code+": "+d[f].error.message)}}}}else for(f=0;f<a.length;f++){e=null;j=a[f];if(callbacks[j]){try{e=callbacks[j]()}catch(k){}delete callbacks[j]}if(!e){alert("There was a server error, please try again. B");
c.responseText&&alert(c.responseText)}}});queue=[]}function autosearchbox(){var a=document.forms.searchbox.query.value;a.toLowerCase().indexOf("wave:")==0||a.toLowerCase().indexOf("new:")==0?hashHandler("#"+a,true):hashHandler("#search:"+a,true)}
function autosearch(a){if(a==current_search&&current_page==1&&search_outdated==false&&!opt.multipane){document.getElementById("suggest").style.display="";searchmode(0);current_page=0;search_container.style.display="";!opt.no_scrollhistory&&!opt.multipane&&scroll_searchpanel(searchscroll);if(!opt.multipane){wave_container.style.display="none";opt.multipane||(msg={});wave_container.innerHTML=""}}else{current_search=document.forms.searchbox.query.value=a;update_search()}if(!opt.multipane)document.getElementById("floating_menu").style.display=
"none"}function searchmode(){}function set_user_mode(a){username.replace(/^.+@/,"");msg.data.waveletData.participants.slice(1).forEach(function(b){wave.wavelet.modifyParticipantRole(b,a||"READ_ONLY",current_wave,msg.data.waveletData.waveletId);alert("done setting "+(msg.data.waveletData.participants.length-1)+" people as "+(a||"READ_ONLY"))});runQueue()}
function add_tag(){var a=prompt("Add tag");if(a){wave.wavelet.addTag(a,msg.data.waveletData.waveId,msg.data.waveletData.waveletId);loadWave(msg.data.waveletData.waveId);auto_reload=true;runQueue()}}
function update_search(){current_page=0;var a=loading(current_search);opt.multipane||(msg={});console.log("updatin surchk");extend_search(0,function(){loading(a);console.log("updatin kawlkbak");document.getElementById("suggest").style.display="";search_container.innerHTML="";searchmode(0);search_container.style.display="";if(!opt.multipane){wave_container.style.display="none";wave_container.innerHTML=""}})}
function auto_extend(a){a.innerHTML="Loading...";extend_search(searchLastIndex+42,function(){a.parentNode.removeChild(a)});runQueue()}if(!window.resultClass)window.resultClass=function(){return""};
function extend_search(a,b){searchLastIndex=a;search_outdated=false;var c=function(d){b&&b();console.log(d);var g="",f=d.data.searchResults.digests;if(opt.prefetch&&onLine()==true){var e=0;setTimeout(function(){var m=f[e++];if(m){var l=m.waveId.replace(/[\/!].+/,"!conv+root");callbacks[wave.robot.fetchWave(m.waveId,l)]=function(o){if(o)prefetched_waves[m.waveId]=o;return true};runQueue();setTimeout(arguments.callee,500)}},1E3)}for(var j=0;j<f.length;j++){d=f[j];d.title=d.title.replace(/\</g,"&lt;").replace(/\>/g,
"&gt;");d.snippet=d.snippet.replace(/\</g,"&lt;").replace(/\>/g,"&gt;");unread_blips[d.waveId]=d.unreadCount;if(opt.old_results)g+='<a href="#wave:'+d.waveId+'" class="searchlink" onclick=\'ch(this)\'><div class="search"><b>'+d.title+"</b> <span style='color:gray'>"+d.snippet+"</div></a>";else{var h=d.unreadCount>0?"<span class='unread_msg'><span class='bubble'>"+d.unreadCount+"</span> of "+d.blipCount+"</span>":"<span class='read_msg'>"+d.blipCount+" msgs</span>",k=format_time(d.lastModified);h=
'<div class="search '+resultClass(d.waveId)+'"><div class="date">'+k+"<br>"+h+'</div><span class="title_'+(d.unreadCount>0?"unread":"read")+'">'+d.title+"</span> <span class='snippet'>"+d.snippet+"</span></div>";g+=d.waveId.indexOf("treq")!=-1?'<a class="searchlink">'+h+"</a>":'<a href="#wave:'+d.waveId+'" class="searchlink" onclick=\'ch(this)\'>'+h+"</a>"}}search_container.innerHTML+=g;search_container.innerHTML+=onLine()==false?'<div class="footer"><b>Sorry!</b> No further waves have been cached.</div>':
f.length<42?f.length==0?current_search.indexOf("is:unread")!=-1?"<div class='footer'><b>Yay</b>, no unread items!</div>":"<div class='footer'>Your search query has <b>zero results</b>. Try broaden your search?</div>":"<div class='footer'><b>Hooray!</b> You've reached the end of the universe!</div>":'<div class="footer" onclick="auto_extend(this);"><b>Extend</b> Search (Page '+(a/42+1)+")</div>"};if(onLine()==true)callbacks[wave.robot.search(current_search,a||0,42)]=c;else{open_db();if(!window.db)return console.log("no database");
db.transaction(function(d){d.executeSql("SELECT * FROM inbox",[],function(g,f){for(var e=[],j=0;j<f.rows.length;j++)e.push(JSON.parse(f.rows.item(j).result));c({data:{searchResults:{digests:e}}})})})}}function ch(a){hashHandler(a.href.substr(a.href.indexOf("#")),true)}
function hashHandler(a,b){var c=lasthash;lasthash=a;if(a.charAt(0)=="#")a=unescape(a.substr(1));if(!(unescape("#"+a)==unescape(c)&&!b)){if(unescape(unescape(unescape(location.hash)))!="#"+unescape(unescape(unescape(a))))location.hash="#"+unescape(unescape(a));if(a.indexOf("search:")==0){autosearch(a.substr(7));runQueue()}else if(a.indexOf("wave:")==0){loadWave(a.substr(5));runQueue()}else a.toLowerCase().indexOf("new:wave")==0&&create_wave()}}
typeof window.onhashchange=="undefined"&&setInterval(function(){window.onhashchange()},100);window.onhashchange=function(){hashHandler(location.hash)};var chronological_blips=[];
function loadWave(a,b){var c=loading(a),d=null,g;if(g=a.match(/(\w+\.\w+)\/(w\+\w+)\/\~\/(\w+\+\w+)\/(b\+\w+)/)){a=g[1]+"!"+g[2];b=g[1]+"!"+g[3];d=g[4]}else{a=a.replace("/","!");b=b||a.replace(/[\/!].+/,"!conv+root")}var f=function(e){loading(c);console.log(e);if(e.error)if(e.error.message.indexOf("not a participant")!=-1){alert("You are not a participant of the wave/wavelet. \nThis may be due to a bug in the current version of the data api which does not allow access to waves unless you are explicitly a participant. don't blame me");return true}else return false;
if(e.data.waveletData){window.msg=e;searchmode(1);if(!opt.multipane)search_container.style.display="none";current_page=1;wave_container.style.display="";update_scroll();document.getElementById("floating_menu").style.display="";if(!opt.no_autoscroll){if(Object.keys)var j=Object.keys(msg.data.blips);else{j=[];for(var h in msg.data.blips)j.push(h)}chronological_blips=j.sort(function(m,l){return msg.data.blips[l].lastModifiedTime-msg.data.blips[m].lastModifiedTime})}scrollto_position=-1;if(!auto_reload)if(!opt.no_scrollhistory){scrollTo(0,
0);if(!opt.no_autoscroll)if(unread_blips[a])scrollto_position=unread_blips[a]-1;if(d)try{scrollto_position=chronological_blips.indexOf(d)}catch(k){}}auto_reload=false;if(!opt.multipane)document.getElementById("suggest").style.display="none";wave_container.innerHTML="";if(opt.owner_utils&&msg.data.waveletData.participants[0]==username)wave_container.innerHTML+='<div><button onclick="set_user_mode()">Everyone Read Only</button><button onclick="set_user_mode(\'FULL\')">Everyone Full Access</button></div>';
j=document.createElement("div");j.className="wavelet";h=document.createElement("a");h.innerHTML=" Add";h.className="addparticipant";h.style["float"]="right";h.href="javascript:void(0)";h.onclick=function(){var m=prompt("Enter Participant ID to Add");if(m){if(m.indexOf("@")==-1)m+="@googlewave.com";wave.wavelet.participant.add(m,a,b);loadWave(a);auto_reload=true;runQueue()}};j.appendChild(h);j.appendChild(userList(e.data.waveletData.participants));wave_container.appendChild(j);current_wave=a=a.replace(/\s/,
"");current_wavelet=b;j=document.createElement("div");wave_container.appendChild(j);if(document.getElementById("chronos").checked)chronological_blip_render(j);else opt.recursive_renderer||!msg.data.waveletData.rootThread?recursive_blip_render(msg.data.waveletData.rootBlipId,j):bootstrap_thread_render(j);j=document.createElement("div");e=e.data.waveletData.tags.join(", ");if(e.length==0)e="(No Tags)";j.innerHTML="<b>Tags:</b> ";j.innerHTML=' <a href="javascript:add_tag()" style="float:right">Add</a>';
j.appendChild(document.createTextNode(e));j.className="tags";wave_container.appendChild(j);e=document.createElement("div");e.innerHTML='<a href="https://wave.google.com/wave/#restored:wave:'+escape(escape(a))+'" target="_blank">Open this wave in the official wave client</a>';e.className="footer";wave_container.appendChild(e);if(opt.bigspace){e=document.createElement("div");e.style.height="250px";wave_container.appendChild(e)}}else alert("The server sent nothing")};if(onLine()==false){open_db();if(!window.db)return console.log("no database");
db.transaction(function(e){e.executeSql("SELECT * FROM inbox WHERE waveid = ?",[a],function(j,h){var k=JSON.parse(h.rows.item(0).data);f(k)})})}else if(opt.prefetch&&prefetched_waves[a])f(JSON.parse(JSON.stringify(prefetched_waves[a])));else callbacks[wave.robot.fetchWave(a,b)]=f}if(!this.JSON)this.JSON={};
(function(){function a(k){return k<10?"0"+k:k}function b(k){g.lastIndex=0;return g.test(k)?'"'+k.replace(g,function(m){var l=j[m];return typeof l==="string"?l:"\\u"+("0000"+m.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+k+'"'}function c(k,m){var l,o,p,s,q=f,r,n=m[k];if(n&&typeof n==="object"&&typeof n.toJSON==="function")n=n.toJSON(k);if(typeof h==="function")n=h.call(m,k,n);switch(typeof n){case "string":return b(n);case "number":return isFinite(n)?String(n):"null";case "boolean":case "null":return String(n);
case "object":if(!n)return"null";f+=e;r=[];if(Object.prototype.toString.apply(n)==="[object Array]"){s=n.length;for(l=0;l<s;l+=1)r[l]=c(l,n)||"null";p=r.length===0?"[]":f?"[\n"+f+r.join(",\n"+f)+"\n"+q+"]":"["+r.join(",")+"]";f=q;return p}if(h&&typeof h==="object"){s=h.length;for(l=0;l<s;l+=1){o=h[l];if(typeof o==="string")if(p=c(o,n))r.push(b(o)+(f?": ":":")+p)}}else for(o in n)if(Object.hasOwnProperty.call(n,o))if(p=c(o,n))r.push(b(o)+(f?": ":":")+p);p=r.length===0?"{}":f?"{\n"+f+r.join(",\n"+f)+
"\n"+q+"}":"{"+r.join(",")+"}";f=q;return p}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var d=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
g=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f,e,j={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},h;if(typeof JSON.stringify!=="function")JSON.stringify=function(k,m,l){var o;e=f="";if(typeof l==="number")for(o=0;o<l;o+=1)e+=" ";else if(typeof l==="string")e=l;if((h=m)&&typeof m!=="function"&&(typeof m!=="object"||typeof m.length!=="number"))throw Error("JSON.stringify");return c("",
{"":k})};if(typeof JSON.parse!=="function")JSON.parse=function(k,m){function l(p,s){var q,r,n=p[s];if(n&&typeof n==="object")for(q in n)if(Object.hasOwnProperty.call(n,q)){r=l(n,q);if(r!==undefined)n[q]=r;else delete n[q]}return m.call(p,s,n)}var o;k=String(k);d.lastIndex=0;if(d.test(k))k=k.replace(d,function(p){return"\\u"+("0000"+p.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(k.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){o=eval("("+k+")");return typeof m==="function"?l({"":o},""):o}throw new SyntaxError("JSON.parse");}})();function startup(){if(onLine()){wave.robot.notifyCapabilitiesHash();getUsername()}if(onLine()==false)document.body.className=document.body.className.replace("online","offline");location.hash.length<2?hashHandler("#search:in:inbox"):hashHandler(location.hash);for(var a=endQueue.length;a--;)endQueue[a]()}
function auto_start(){window.NO_STARTUP||startup();window.offline_cache&&opt.offline&&onLine()&&setTimeout(offline_cache,1337)}auto_start();
